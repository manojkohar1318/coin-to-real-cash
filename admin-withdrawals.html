<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Withdrawal Requests</title>
  <link rel="stylesheet" href="assets/css/admin-withdrawals.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>
  <div class="admin-container">
    <header>
      <h1>Admin Dashboard</h1>
      <div class="admin-actions">
        <button id="changePassBtn" class="pass-btn">
          <i class="fas fa-key"></i> Change Password
        </button>
        <button id="logoutBtn" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <div class="columns">
      <div class="column" id="pending-column">
        <h2>Pending Requests</h2>
        <ul id="pending-list"></ul>
      </div>

      <div class="column" id="approved-column">
        <h2>Approved Requests</h2>
        <ul id="approved-list"></ul>
      </div>

      <div class="column" id="rejected-column">
        <h2>Rejected Requests</h2>
        <ul id="rejected-list"></ul>
      </div>
    </div>
  </div>
<script>
  // ðŸ”¥ Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAkWyk3q-zaDHkjDs90Bm2ih_qw-O_ZJQU",
    authDomain: "coin-to-real-cash.firebaseapp.com",
    databaseURL: "https://coin-to-real-cash-default-rtdb.firebaseio.com",
    projectId: "coin-to-real-cash",
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const auth = firebase.auth();

  // Elements
  const pendingList = document.getElementById("pending-list");
  const approvedList = document.getElementById("approved-list");
  const rejectedList = document.getElementById("rejected-list");
  const changePassBtn = document.getElementById("changePassBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  // âœ… CHANGE PASSWORD (Sends reset email)
  changePassBtn.addEventListener("click", () => {
    const adminEmail = "cointorealcash@gmail.com";
    auth
      .sendPasswordResetEmail(adminEmail)
      .then(() => {
        alert(`A password reset link has been sent to ${adminEmail}. Please check your inbox.`);
      })
      .catch((error) => {
        console.error("Error sending reset email:", error);
        alert("Failed to send reset link. Make sure the admin email is correct or logged in.");
      });
  });

  // âœ… LOGOUT FUNCTION
  logoutBtn.addEventListener("click", () => {
    auth.signOut().then(() => {
      window.location.href = "index.html";
    });
  });

  // âœ… Render withdrawal request
  function renderRequest(uid, username, reqId, data) {
    const li = document.createElement("li");
    li.classList.add("request-item");

    li.innerHTML = `
      <div class="request-info">
        <p><strong>Username:</strong> ${username || "Unknown User"}</p>
        <p><strong>Amount:</strong> â‚¹${data.amount}</p>
        <p><strong>Method:</strong> ${data.method}</p>
        ${
          data.method === "upi"
            ? `<p><strong>UPI ID:</strong> ${data.details?.upiId || "N/A"}</p>`
            : `<p><strong>Account No:</strong> ${data.details?.accountNumber || "N/A"}<br>
               <strong>IFSC:</strong> ${data.details?.ifscCode || "N/A"}</p>`
        }
        <h5><strong>Status:</strong> 
          <span class="status ${data.status.replace(/\s/g, "")}">${data.status}</span>
        </h5>
        ${
          data.remark
            ? `<p class="remark-display"><strong>Remark:</strong> ${data.remark}</p>`
            : ""
        }
      </div>
    `;

    if (data.status === "Pending") {
      const btnContainer = document.createElement("div");
      btnContainer.classList.add("actions");

      const remarkInput = document.createElement("textarea");
      remarkInput.placeholder = "Add remark message...";
      remarkInput.classList.add("remark-input");

      const approveBtn = document.createElement("button");
      approveBtn.textContent = "Approve";
      approveBtn.classList.add("approve-btn");
      approveBtn.onclick = () =>
        updateStatus(uid, username, reqId, "Withdrawal Successful", remarkInput.value);

      const rejectBtn = document.createElement("button");
      rejectBtn.textContent = "Reject";
      rejectBtn.classList.add("reject-btn");
      rejectBtn.onclick = () => {
        const remark = remarkInput.value.trim();
        if (!remark) {
          alert("Please add a remark before rejecting.");
          return;
        }
        updateStatus(uid, username, reqId, "Rejected", remark);
      };

      btnContainer.appendChild(remarkInput);
      btnContainer.appendChild(approveBtn);
      btnContainer.appendChild(rejectBtn);
      li.appendChild(btnContainer);
    }

    return li;
  }

  // âœ… Update status and refund logic (fixed: rupees -> coins conversion)
  async function updateStatus(uid, username, reqId, newStatus, remark = "") {
    const ref = db.ref(`withdrawals/${uid}/${reqId}`);
    const snapshot = await ref.once("value");
    const data = snapshot.val();

    if (!data) {
      alert("Request not found.");
      return;
    }

    await ref.update({
      status: newStatus,
      remark: remark || null,
    });

    // ðŸ’° Refund if rejected (convert rupees -> coins using 100 coins = â‚¹1)
    if (newStatus === "Rejected") {
      try {
        const userRef = db.ref(`users/${uid}`);
        const userSnap = await userRef.once("value");
        const userData = userSnap.val();

        if (userData) {
          // parse amount as rupees (allow decimals), then convert to coins
          const rupees = parseFloat(String(data.amount || "0")) || 0;
          const refundCoins = Math.round(rupees * 100); // 100 coins = â‚¹1

          const currentCoins = parseInt(userData.coins || 0, 10) || 0;
          const newBalance = currentCoins + refundCoins;

          await userRef.update({ coins: newBalance });

          alert(
            `Request rejected. â‚¹${rupees.toFixed(2)} converted to ${refundCoins} coins and refunded to ${username}'s account.`
          );
        } else {
          console.error("User not found for refund.");
          alert("User not found â€” refund not completed.");
        }
      } catch (err) {
        console.error("Refund failed:", err);
        alert("Error refunding coins. Check console for details.");
      }
    } else {
      alert(`Request marked as ${newStatus}`);
    }
  }

  // âœ… Save data locally for offline use
  function saveOfflineData(data) {
    localStorage.setItem("withdrawalCache", JSON.stringify(data));
  }

  // âœ… Load cached data when offline
  function loadOfflineData() {
    const cached = localStorage.getItem("withdrawalCache");
    if (cached) {
      const { allRequests } = JSON.parse(cached);
      renderAllRequests(allRequests);
    } else {
      pendingList.innerHTML =
        "<li>No cached data available. Please connect to the internet.</li>";
    }
  }

  // âœ… Render requests into 3 columns
  function renderAllRequests(allRequests) {
    pendingList.innerHTML = "";
    approvedList.innerHTML = "";
    rejectedList.innerHTML = "";

    allRequests.sort((a, b) => (b.data.timestamp || 0) - (a.data.timestamp || 0));

    allRequests.forEach(({ uid, username, reqId, data }) => {
      const item = renderRequest(uid, username, reqId, data);
      if (data.status === "Pending") {
        pendingList.appendChild(item);
      } else if (data.status === "Withdrawal Successful") {
        approvedList.appendChild(item);
      } else if (data.status === "Rejected") {
        rejectedList.appendChild(item);
      }
    });
  }

  // âœ… Load data (online + cache)
  async function loadWithdrawalRequests() {
    try {
      const usersSnap = await db.ref("users").once("value");
      const users = usersSnap.val() || {};

      db.ref("withdrawals").on("value", (snapshot) => {
        const allRequests = [];

        snapshot.forEach((userSnap) => {
          const uid = userSnap.key;
          const username = users[uid]?.username || "Unknown";
          userSnap.forEach((reqSnap) => {
            allRequests.push({
              uid,
              username,
              reqId: reqSnap.key,
              data: reqSnap.val(),
            });
          });
        });

        renderAllRequests(allRequests);
        saveOfflineData({ allRequests });
      });
    } catch (err) {
      console.error("Error loading data:", err);
      loadOfflineData(); // fallback to cached data if Firebase fails
    }
  }

  // âœ… Check if online or offline
  window.addEventListener("load", () => {
    if (navigator.onLine) {
      loadWithdrawalRequests();
    } else {
      console.warn("Offline mode: showing cached data");
      loadOfflineData();
    }
  });

  // When internet comes back, reload fresh data
  window.addEventListener("online", () => {
    loadWithdrawalRequests();
  });
</script>
</body>
</html>