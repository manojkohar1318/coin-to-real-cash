<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Withdrawal Requests</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #f9fbff;
      margin: 0;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
    }

    header h1 {
      font-size: 20px;
      margin: 0;
    }

    .admin-actions button {
      background: white;
      color: #007bff;
      border: none;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.2s, color 0.2s;
    }

    .admin-actions button:hover {
      background: #0056b3;
      color: white;
    }

    .columns {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .column {
      flex: 1;
      min-width: 300px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 15px;
    }

    .column h2 {
      text-align: center;
      color: #007bff;
      font-size: 18px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .request-item {
      border: 2px solid #eee;
      border-left: 5px solid orange;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 10px;
      background-color: #fff;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .request-item:hover {
      transform: scale(1.01);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .request-info p {
      margin: 4px 0;
      font-size: 14px;
    }

    .status {
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 10px;
      background-color: #f2f2f2;
      display: inline-block;
    }

    .status.Pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .status.Rejected {
      background-color: #f8d7da;
      color: #721c24;
    }

    .status.WithdrawalSuccessful {
      background-color: #d4edda;
      color: #10b981;
    }

    .remark-input {
      width: 100%;
      height: 50px;
      margin: 6px 0;
      padding: 6px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: none;
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    .approve-btn,
    .reject-btn {
      flex: 1;
      padding: 6px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 13px;
    }

    .approve-btn {
      background-color: #28a745;
    }

    .reject-btn {
      background-color: #dc3545;
    }
  </style>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3213109580536726"
     crossorigin="anonymous"></script>
</head>

<body>
  <div class="admin-container">
    <header>
      <h1>Admin Dashboard</h1>
      <div class="admin-actions">
        <button id="changePassBtn" class="pass-btn">
          <i class="fas fa-key"></i> Change Password
        </button>
        <button id="logoutBtn" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <div class="columns">
      <div class="column" id="pending-column">
        <h2>Pending Requests</h2>
        <ul id="pending-list"></ul>
      </div>

      <div class="column" id="approved-column">
        <h2>Approved Requests</h2>
        <ul id="approved-list"></ul>
      </div>

      <div class="column" id="rejected-column">
        <h2>Rejected Requests</h2>
        <ul id="rejected-list"></ul>
      </div>
    </div>
  </div>

  <script>
    // ðŸ”¥ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAkWyk3q-zaDHkjDs90Bm2ih_qw-O_ZJQU",
      authDomain: "coin-to-real-cash.firebaseapp.com",
      databaseURL: "https://coin-to-real-cash-default-rtdb.firebaseio.com",
      projectId: "coin-to-real-cash"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    // Elements
    const pendingList = document.getElementById("pending-list");
    const approvedList = document.getElementById("approved-list");
    const rejectedList = document.getElementById("rejected-list");

    // âœ… Logout Functionality
    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut()
        .then(() => {
          alert("Logged out successfully!");
          window.location.href = "index.html"; // redirect to login page
        })
        .catch((error) => {
          console.error("Logout Error:", error);
          alert("Error logging out. Check console.");
        });
    });

    // âœ… Change Password Functionality
    document.getElementById("changePassBtn").addEventListener("click", () => {
      const user = auth.currentUser;
      if (!user) {
        alert("No admin logged in!");
        return;
      }

      const oldPassword = prompt("Enter your current password:");
      const newPassword = prompt("Enter your new password (min 6 chars):");
      if (!oldPassword || !newPassword) return;

      const cred = firebase.auth.EmailAuthProvider.credential(user.email, oldPassword);
      user.reauthenticateWithCredential(cred)
        .then(() => {
          return user.updatePassword(newPassword);
        })
        .then(() => {
          alert("Password changed successfully!");
        })
        .catch((error) => {
          console.error("Password Change Error:", error);
          alert("Error changing password. Please check the old password or try again.");
        });
    });

    // ðŸ§© Load Users
    let usersData = {};
    db.ref("users").once("value").then(snapshot => {
      usersData = snapshot.val() || {};
      console.log("âœ… Users loaded:", usersData);
    });

   // âœ… Render Request
function renderRequest(uid, reqId, data) {
  const li = document.createElement("li");
  li.classList.add("request-item");

  // Temporary placeholder until username loads
  li.innerHTML = `
    <div class="request-info">
      <p><strong>User:</strong> Loading...</p>
      <p><strong>Amount:</strong> â‚¹${data.amount}</p>
      <p><strong>Method:</strong> ${data.method}</p>
      ${
        data.method === "upi"
          ? `<p><strong>UPI ID:</strong> ${data.details?.upiId || "N/A"}</p>`
          : `<p><strong>Account No:</strong> ${data.details?.accountNumber || "N/A"}<br>
              <strong>IFSC:</strong> ${data.details?.ifscCode || "N/A"}</p>`
      }
      <p><strong>Status:</strong> <span class="status ${data.status.replace(/\s/g, '')}">
        ${data.status}
      </span></p>
      ${
        data.remark
          ? `<p class="remark-display"><strong>Remark:</strong> ${data.remark}</p>`
          : ""
      }
    </div>
  `;

  // âœ… Fetch username from Firebase Realtime Database
  const userRef = firebase.database().ref(`users/${uid}/username`);
  userRef.once("value")
    .then((snapshot) => {
      const username = snapshot.val() || "Unknown User";
      const userEl = li.querySelector(".request-info p strong");
      if (userEl) userEl.parentElement.innerHTML = `<strong>User:</strong> ${username}`;
    })
    .catch((error) => {
      console.error("Error fetching username:", error);
    });

      if (data.status === "Pending") {
        const controlsContainer = document.createElement("div");
        const remarkInput = document.createElement("textarea");
        remarkInput.id = `remark-${reqId}`;
        remarkInput.placeholder = "Enter remark message (e.g., Transaction ID, reason for rejection)";
        remarkInput.classList.add("remark-input");

        const btnContainer = document.createElement("div");
        btnContainer.classList.add("actions");

        const approveBtn = document.createElement("button");
        approveBtn.textContent = "Approve";
        approveBtn.classList.add("approve-btn");
        approveBtn.onclick = () => {
          const remark = remarkInput.value;
          if (confirm("Approve this request?")) updateStatus(uid, reqId, "Withdrawal Successful", remark);
        };

        const rejectBtn = document.createElement("button");
        rejectBtn.textContent = "Reject";
        rejectBtn.classList.add("reject-btn");
        rejectBtn.onclick = () => {
          const remark = remarkInput.value;
          if (!remark) {
            alert("Please enter a remark before rejecting.");
            return;
          }
          if (confirm("Reject this request?")) updateStatus(uid, reqId, "Rejected", remark);
        };

        btnContainer.appendChild(approveBtn);
        btnContainer.appendChild(rejectBtn);
        controlsContainer.appendChild(remarkInput);
        controlsContainer.appendChild(btnContainer);
        li.appendChild(controlsContainer);
      }

      return li;
    }

    // âœ… Update Status
    function updateStatus(uid, reqId, newStatus, remark = "") {
      const ref = db.ref(`withdrawals/${uid}/${reqId}`);
      const finalRemark = remark.trim() === "" ? null : remark.trim();
      ref.update({
        status: newStatus,
        remark: finalRemark
      }).then(() => {
        alert(`Status updated to ${newStatus}`);
      }).catch(err => console.error("Update failed:", err));
    }

    // âœ… Listen to All Withdrawals
    db.ref("withdrawals").on("value", (snapshot) => {
      pendingList.innerHTML = "";
      approvedList.innerHTML = "";
      rejectedList.innerHTML = "";

      snapshot.forEach((userSnap) => {
        const uid = userSnap.key;
        userSnap.forEach((reqSnap) => {
          const reqId = reqSnap.key;
          const data = reqSnap.val();
          const item = renderRequest(uid, reqId, data);
          if (data.status === "Pending") pendingList.appendChild(item);
          else if (data.status === "Withdrawal Successful") approvedList.appendChild(item);
          else if (data.status === "Rejected") rejectedList.appendChild(item);
        });
      });
    });
  </script>
</body>
</html>
