<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin - Withdrawal Requests</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #f9fbff;
      margin: 0;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #007bff;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
    }

    header h1 {
      font-size: 20px;
      margin: 0;
    }

    .admin-actions button {
      background: white;
      color: #007bff;
      border: none;
      padding: 6px 10px;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 8px;
      font-weight: 600;
      font-size: 14px;
      transition: background 0.2s, color 0.2s;
    }

    .admin-actions button:hover {
      background: #0056b3;
      color: white;
    }

    .columns {
      display: flex;
      gap: 20px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    .column {
      flex: 1;
      min-width: 300px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      padding: 15px;
    }

    .column h2 {
      text-align: center;
      color: #007bff;
      font-size: 18px;
    }

    ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .request-item {
      border: 2px solid #eee;
      border-left: 5px solid orange;
      border-radius: 8px;
      padding: 10px 12px;
      margin-bottom: 10px;
      background-color: #fff;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .request-item:hover {
      transform: scale(1.01);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .request-info p {
      margin: 4px 0;
      font-size: 14px;
    }

    .status {
      font-weight: bold;
      padding: 3px 8px;
      border-radius: 10px;
      background-color: #f2f2f2;
      display: inline-block;
    }

    .status.Pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .status.Rejected {
      background-color: #f8d7da;
      color: #721c24;
    }

    .status.WithdrawalSuccessful {
      background-color: #d4edda;
      color: #10b981;
    }

    .remark-input {
      width: 100%;
      height: 50px;
      margin: 6px 0;
      padding: 6px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: none;
    }

    .actions {
      display: flex;
      gap: 10px;
    }

    .approve-btn,
    .reject-btn {
      flex: 1;
      padding: 6px;
      border: none;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      font-size: 13px;
    }

    .approve-btn {
      background-color: #28a745;
    }

    .reject-btn {
      background-color: #dc3545;
    }
  </style>
</head>

<body>
  <div class="admin-container">
    <header>
      <h1>Admin Dashboard</h1>
      <div class="admin-actions">
        <button id="changePassBtn" class="pass-btn">
          <i class="fas fa-key"></i> Change Password
        </button>
        <button id="logoutBtn" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </header>

    <div class="columns">
      <div class="column" id="pending-column">
        <h2>Pending Requests</h2>
        <ul id="pending-list"></ul>
      </div>

      <div class="column" id="approved-column">
        <h2>Approved Requests</h2>
        <ul id="approved-list"></ul>
      </div>

      <div class="column" id="rejected-column">
        <h2>Rejected Requests</h2>
        <ul id="rejected-list"></ul>
      </div>
    </div>
  </div>

 <script>
Â  Â  // ðŸ”¥ Firebase Config
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyAkWyk3q-zaDHkjDs90Bm2ih_qw-O_ZJQU",
Â  Â  Â  authDomain: "coin-to-real-cash.firebaseapp.com",
Â  Â  Â  databaseURL: "https://coin-to-real-cash-default-rtdb.firebaseio.com",
Â  Â  Â  projectId: "coin-to-real-cash"
Â  Â  };

Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.database();
Â  Â  const auth = firebase.auth();

Â  Â  // Global Data Store
Â  Â  let usersData = {};
Â  Â  
Â  Â  // Elements
Â  Â  const pendingList = document.getElementById("pending-list");
Â  Â  const approvedList = document.getElementById("approved-list");
Â  Â  const rejectedList = document.getElementById("rejected-list");
    
    // Custom Modal elements
    const customModal = document.getElementById("custom-modal");
    const modalMessage = document.getElementById("modal-message");
    const modalOkBtn = document.getElementById("modal-ok-btn");
    const modalCancelBtn = document.getElementById("modal-cancel-btn");

    /**
     * Replacement for alert().
     */
    function showCustomAlert(message) {
        modalMessage.textContent = message;
        modalCancelBtn.style.display = 'none';
        modalOkBtn.onclick = () => customModal.style.display = 'none';
        customModal.style.display = 'block';
    }
    
    /**
     * Replacement for confirm().
     */
    function showCustomConfirm(message, onConfirm) {
        modalMessage.textContent = message;
        modalCancelBtn.style.display = 'inline-block';
        
        modalOkBtn.onclick = () => {
            customModal.style.display = 'none';
            onConfirm(true);
        };
        
        modalCancelBtn.onclick = () => {
            customModal.style.display = 'none';
            onConfirm(false);
        };
        customModal.style.display = 'block';
    }

Â  Â  // âœ… Logout Functionality
Â  Â  document.getElementById("logoutBtn").addEventListener("click", () => {
Â  Â  Â  auth.signOut()
Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  showCustomAlert("Logged out successfully!");
Â  Â  Â  Â  Â  // window.location.href = "index.html"; // Redirect to login page - uncomment if needed
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  console.error("Logout Error:", error);
Â  Â  Â  Â  Â  showCustomAlert("Error logging out. Check console.");
Â  Â  Â  Â  });
Â  Â  });

Â  Â  // âœ… Change Password Functionality
Â  Â  document.getElementById("changePassBtn").addEventListener("click", () => {
Â  Â  Â  const user = auth.currentUser;
Â  Â  Â  if (!user) {
Â  Â  Â  Â  showCustomAlert("No admin logged in!");
Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  // Since prompt() is also blocked in some environments, we'll use a placeholder for now
      // and log the need for a better UI.
      console.log("Password change initiated. A proper UI modal is required here.");
Â  Â  Â  showCustomAlert("Password change requires input fields. Check the console for next steps.");
      /* // Replace with a proper modal UI for old/new password input
Â  Â  Â  const oldPassword = prompt("Enter your current password:");
Â  Â  Â  const newPassword = prompt("Enter your new password (min 6 chars):");
Â  Â  Â  if (!oldPassword || !newPassword) return;

Â  Â  Â  const cred = firebase.auth.EmailAuthProvider.credential(user.email, oldPassword);
Â  Â  Â  user.reauthenticateWithCredential(cred)
Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  return user.updatePassword(newPassword);
Â  Â  Â  Â  })
Â  Â  Â  Â  .then(() => {
Â  Â  Â  Â  Â  showCustomAlert("Password changed successfully!");
Â  Â  Â  Â  })
Â  Â  Â  Â  .catch((error) => {
Â  Â  Â  Â  Â  console.error("Password Change Error:", error);
Â  Â  Â  Â  Â  showCustomAlert("Error changing password. Check console.");
Â  Â  Â  Â  });
      */
Â  Â  });


Â  Â  // âœ… Render Request
Â  Â  function renderRequest(uid, reqId, data) {
Â  Â  Â  const li = document.createElement("li");
Â  Â  Â  li.classList.add("request-item");
      // Use the globally loaded usersData
Â  Â  Â  const username = usersData[uid]?.username || "Unknown User";
Â  Â  Â  const statusClass = data.status.replace(/\s/g, '');

Â  Â  Â  li.innerHTML = `
Â  Â  Â  Â  <div class="request-info">
Â  Â  Â  Â  Â  <p><strong>User ID:</strong> ${uid}</p>
Â  Â  Â  Â  Â  <p><strong>User:</strong> ${username}</p>
Â  Â  Â  Â  Â  <p><strong>Amount:</strong> â‚¹${data.amount}</p>
Â  Â  Â  Â  Â  <p><strong>Method:</strong> ${data.method}</p>
Â  Â  Â  Â  Â  ${data.method === "upi"
Â  Â  Â  Â  Â  Â  ? `<p><strong>UPI ID:</strong> ${data.details?.upiId || "N/A"}</p>`
Â  Â  Â  Â  Â  Â  : `<p><strong>Account No:</strong> ${data.details?.accountNumber || "N/A"}<br>
Â  Â  Â  Â  Â  Â  Â  <strong>IFSC:</strong> ${data.details?.ifscCode || "N/A"}</p>`}
Â  Â  Â  Â  Â  <p><strong>Status:</strong> <span class="status ${statusClass}">${data.status}</span></p>
Â  Â  Â  Â  Â  ${data.remark ? `<p class="remark-display"><strong>Remark:</strong> ${data.remark}</p>` : ""}
Â  Â  Â  Â  </div>
Â  Â  Â  `;

Â  Â  Â  if (data.status === "Pending") {
Â  Â  Â  Â  const controlsContainer = document.createElement("div");
Â  Â  Â  Â  const remarkInput = document.createElement("textarea");
Â  Â  Â  Â  remarkInput.id = `remark-${reqId}`;
Â  Â  Â  Â  remarkInput.placeholder = "Enter remark message (e.g., Transaction ID, reason for rejection)";
Â  Â  Â  Â  remarkInput.classList.add("remark-input");

Â  Â  Â  Â  const btnContainer = document.createElement("div");
Â  Â  Â  Â  btnContainer.classList.add("actions");

Â  Â  Â  Â  const approveBtn = document.createElement("button");
Â  Â  Â  Â  approveBtn.textContent = "Approve";
Â  Â  Â  Â  approveBtn.classList.add("approve-btn");
Â  Â  Â  Â  approveBtn.onclick = () => {
Â  Â  Â  Â  Â  const remark = remarkInput.value;
          showCustomConfirm("Approve this request?", (confirmed) => {
            if (confirmed) {
              updateStatus(uid, reqId, "Withdrawal Successful", remark);
            }
          });
Â  Â  Â  Â  };

Â  Â  Â  Â  const rejectBtn = document.createElement("button");
Â  Â  Â  Â  rejectBtn.textContent = "Reject";
Â  Â  Â  Â  rejectBtn.classList.add("reject-btn");
Â  Â  Â  Â  rejectBtn.onclick = () => {
Â  Â  Â  Â  Â  const remark = remarkInput.value;
Â  Â  Â  Â  Â  if (!remark.trim()) {
Â  Â  Â  Â  Â  Â  showCustomAlert("Please enter a remark before rejecting.");
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }
          showCustomConfirm("Reject this request?", (confirmed) => {
            if (confirmed) {
              updateStatus(uid, reqId, "Rejected", remark);
            }
          });
Â  Â  Â  Â  };

Â  Â  Â  Â  btnContainer.appendChild(approveBtn);
Â  Â  Â  Â  btnContainer.appendChild(rejectBtn);
Â  Â  Â  Â  controlsContainer.appendChild(remarkInput);
Â  Â  Â  Â  controlsContainer.appendChild(btnContainer);
Â  Â  Â  Â  li.appendChild(controlsContainer);
Â  Â  Â  }

Â  Â  Â  return li;
Â  Â  }

Â  Â  // âœ… Update Status
Â  Â  function updateStatus(uid, reqId, newStatus, remark = "") {
Â  Â  Â  const ref = db.ref(`withdrawals/${uid}/${reqId}`);
Â  Â  Â  const finalRemark = remark.trim() === "" ? null : remark.trim();
Â  Â  Â  ref.update({
Â  Â  Â  Â  status: newStatus,
Â  Â  Â  Â  remark: finalRemark
Â  Â  Â  }).then(() => {
Â  Â  Â  Â  showCustomAlert(`Status updated to ${newStatus}`);
Â  Â  Â  }).catch(err => {
        console.error("Update failed:", err);
        showCustomAlert("Update failed! Check console for errors (e.g., security rules).");
      });
Â  Â  }
    
    // ðŸš€ Main function to ensure data loading order
    async function loadDataAndStartListeners() {
        try {
            // 1. Load All Users Data FIRST
            const usersSnapshot = await db.ref("users").once("value");
            usersData = usersSnapshot.val() || {};
            console.log("âœ… Users data loaded successfully.");
            
            // 2. Start Withdrawal Listener AFTER usersData is ready
            db.ref("withdrawals").on("value", (snapshot) => {
                pendingList.innerHTML = "";
                approvedList.innerHTML = "";
                rejectedList.innerHTML = "";

                snapshot.forEach((userSnap) => {
                    const uid = userSnap.key;
                    userSnap.forEach((reqSnap) => {
                        const reqId = reqSnap.key;
                        const data = reqSnap.val();
                        const item = renderRequest(uid, reqId, data);
                        if (data.status === "Pending") pendingList.appendChild(item);
                        else if (data.status === "Withdrawal Successful") approvedList.appendChild(item);
                        else if (data.status === "Rejected") rejectedList.appendChild(item);
                    });
                });
            });
            console.log("âœ… Withdrawal listener started.");

        } catch (error) {
            console.error("Fatal initialization error:", error);
            showCustomAlert("Error loading initial data. Check console for details.");
        }
    }

    // Call the main function to start the app logic
    loadDataAndStartListeners();
    
    // Add an event listener to close the modal when clicking outside
    customModal.addEventListener('click', function(e) {
        if (e.target === customModal) {
            customModal.style.display = 'none';
        }
    });

Â  </script>
</body>
</html>
