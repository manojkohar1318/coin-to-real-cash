<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spin Wheel</title>
<link rel="stylesheet" href="assets/css/spin.css">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3213109580536726"
     crossorigin="anonymous"></script>
</head>
<body>

<a href="home.html" class="back-btn">&#8592; Back</a>

<div class="container">
  <div class="pointer"></div>
  <div class="wheel" id="wheel"></div>
</div>

<a href="#" class="spinBtn-2 btn">Play</a>

<div class="overlay"></div>
<div class="message" id="winMessage"></div>

<div id="balanceDisplay" style="position: fixed; top: 10px; right: 10px; padding: 10px; background: #fff; border: 1px solid #ccc; border-radius: 5px;">
  Balance: <span id="currentBalance">0</span>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAkWyk3q-zaDHkjDs90Bm2ih_qw-O_ZJQU",
  authDomain: "coin-to-real-cash.firebaseapp.com",
  databaseURL: "https://coin-to-real-cash-default-rtdb.firebaseio.com",
  projectId: "coin-to-real-cash",
  storageBucket: "coin-to-real-cash.firebasestorage.app",
  messagingSenderId: "265929655267",
  appId: "1:265929655267:web:7eb846fe7bd104761a56d6"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

const wheel = document.getElementById('wheel');
const spinBtn2 = document.querySelector('.spinBtn-2');
const message = document.getElementById('winMessage');
const overlay = document.querySelector('.overlay');
const balanceDisplay = document.getElementById('currentBalance');

const values = [2, 1, 50, 0, 100, 10, 5, 20];
const colors = ['#db7093', '#20b2aa', '#d63e92', '#daa520', '#ff34f0', '#ff7f50', '#3cb371', '#4169e1'];

wheel.innerHTML = values.map((val, i) => `
  <div class="number" style="--i:${i+1};--clr:${colors[i]}"><span>${val}</span></div>
`).join('');

let deg = 0;
let currentPrize = 0;

// ========== FIREBASE AUTH =============
auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  const userRef = db.ref("users/" + user.uid);

  // Live balance update
  userRef.on("value", snapshot => {
    const data = snapshot.val();
    if (data) balanceDisplay.textContent = data.coins;
  });

  // Spin button click
  spinBtn2.addEventListener("click", e => {
    e.preventDefault();
    spinBtn2.style.pointerEvents = 'none';
    message.style.display = 'none';
    overlay.style.display = 'none';

    const extraSpin = 3600;
    const randomDegree = Math.floor(Math.random() * 360);
    deg += extraSpin + randomDegree;

    wheel.style.transform = `rotate(${deg}deg)`;

    setTimeout(() => {
      const actualDeg = deg % 360;
      const segmentAngle = 360 / values.length;
      const offset = segmentAngle / 2;
      const index = Math.floor((actualDeg + offset) / segmentAngle) % values.length;
      currentPrize = values[(values.length - index + values.length) % values.length];

      overlay.style.display = 'block';
      message.style.display = 'block';
      message.innerHTML = `
        <h2>ðŸŽ‰ Congratulations!</h2>
        <p>You won <span style="color:#1e90ff; font-weight:bold; font-size:1.5em;">${currentPrize}</span> coins!</p>
        <div class="action-buttons">
          <button id="addBalanceBtn">Add to Main Balance</button>
        </div>
      `;

      document.getElementById("addBalanceBtn").addEventListener("click", () => {
        showAdOverlay(userRef, currentPrize);
      });
    }, 5000);
  });
});

// ========== REWARD FUNCTION ==========
function rewardUser(userRef, currentPrize) {
  userRef.get().then(snapshot => {
    const data = snapshot.val();
    const newCoins = (data.coins || 0) + currentPrize;
    const newTodays = (data.todaysEarnings || 0) + currentPrize;

    userRef.update({ coins: newCoins, todaysEarnings: newTodays }).then(() => {
      document.querySelector('.overlay').style.display = 'none';
      document.getElementById('winMessage').style.display = 'none';
      document.querySelector('.spinBtn-2').style.pointerEvents = 'auto';
      alert(`âœ… ${currentPrize} coins added to your main balance!`);
    });
  });
}
</script>

<!-- =================== ADMOB REWARDED VIDEO SCRIPT =================== -->
<script type="text/javascript">
document.addEventListener('deviceready', async function () {
  console.log("Device is ready â€” initializing AdMob...");
  
  try {
    await admob.start();

    // Create and preload Rewarded Ad
    window.rewardedAd = new admob.RewardedAd({
      adUnitId: 'ca-app-pub-3213109580536726/5751573055' // real id
    });
    await window.rewardedAd.load();
    console.log("Rewarded ad preloaded successfully!");
  } catch (err) {
    console.error("AdMob init error:", err);
  }
});

// Show Ad when Add button clicked
async function showAdOverlay(userRef, currentPrize) {
  if (!window.rewardedAd) {
    alert("Ad is still loading. Please wait a moment.");
    return;
  }

  try {
    await window.rewardedAd.show();
    console.log("Ad shown successfully");

    // If ad finishes and reward is earned
    window.rewardedAd.on('rewarded', () => {
      console.log('Ad reward event triggered!');
      rewardUser(userRef, currentPrize);
    });

    // If user closes early, wait 25 seconds before reward
    window.rewardedAd.on('dismissed', () => {
      console.log('Ad closed early. Delaying reward...');
      setTimeout(() => {
        rewardUser(userRef, currentPrize);
      }, 25000);
    });

    // Reload a new ad after showing
    window.rewardedAd.on('dismissed', async () => {
      try {
        await window.rewardedAd.load();
        console.log("Ad reloaded for next time");
      } catch (err) {
        console.log("Failed to reload ad:", err);
      }
    });

  } catch (err) {
    console.log("Ad failed to show:", err);
    // Fallback: still reward if ad fails
    rewardUser(userRef, currentPrize);
  }
}
</script>

</body>
</html>


