<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spin Wheel</title>
<link rel="stylesheet" href="assets/css/spin.css">
</head>
<body>

<a href="home.html" class="back-btn">&#8592; Back</a>

<div class="container">
  <div class="pointer"></div>
  <div class="wheel" id="wheel"></div>
</div>

<a href="#" class="spinBtn-2 btn">Play</a>

<div class="overlay"></div>
<div class="message" id="winMessage"></div>

<div id="balanceDisplay" style="position: fixed; top: 10px; right: 10px; padding: 10px; background: #fff; border: 1px solid #ccc; border-radius: 5px;">
  Balance: <span id="currentBalance">0</span>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAkWyk3q-zaDHkjDs90Bm2ih_qw-O_ZJQU",
  authDomain: "coin-to-real-cash.firebaseapp.com",
  databaseURL: "https://coin-to-real-cash-default-rtdb.firebaseio.com",
  projectId: "coin-to-real-cash",
  storageBucket: "coin-to-real-cash.firebasestorage.app",
  messagingSenderId: "265929655267",
  appId: "1:265929655267:web:7eb846fe7bd104761a56d6"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();

const wheel = document.getElementById('wheel');
const spinBtn2 = document.querySelector('.spinBtn-2');
const message = document.getElementById('winMessage');
const overlay = document.querySelector('.overlay');
const balanceDisplay = document.getElementById('currentBalance');

const values = [2, 1, 50, 0, 100, 10, 5, 20];
const colors = ['#db7093', '#20b2aa', '#d63e92', '#daa520', '#ff34f0', '#ff7f50', '#3cb371', '#4169e1'];

wheel.innerHTML = values.map((val, i) => `
  <div class="number" style="--i:${i+1};--clr:${colors[i]}"><span>${val}</span></div>
`).join('');

let deg = 0;
let currentPrize = 0;

auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  const userRef = db.ref("users/" + user.uid);

  // Live balance update
  userRef.on("value", snapshot => {
    const data = snapshot.val();
    if (data) balanceDisplay.textContent = data.coins;
  });

  spinBtn2.addEventListener("click", e => {
    e.preventDefault();
    spinBtn2.style.pointerEvents = 'none';
    message.style.display = 'none';
    overlay.style.display = 'none';

    const extraSpin = 3600;
    const randomDegree = Math.floor(Math.random() * 360);
    deg += extraSpin + randomDegree;

    wheel.style.transform = `rotate(${deg}deg)`;

    setTimeout(() => {
      const actualDeg = deg % 360;
      const segmentAngle = 360 / values.length;
      const offset = segmentAngle / 2;
      const index = Math.floor((actualDeg + offset) / segmentAngle) % values.length;
      currentPrize = values[(values.length - index + values.length) % values.length];

      overlay.style.display = 'block';
      message.style.display = 'block';
      message.innerHTML = `
        <h2>ðŸŽ‰ Congratulations!</h2>
        <p>You won <span style="color:#1e90ff; font-weight:bold; font-size:1.5em;">${currentPrize}</span> coins!</p>
        <div class="action-buttons">
          <button id="addBalanceBtn">Add to Main Balance</button>
        </div>
      `;

      document.getElementById("addBalanceBtn").addEventListener("click", () => {
        showAdOverlay(userRef, currentPrize);
      });
    }, 5000);
  });
});

// ---------------------------
//  Ad Overlay + Skip Button (Fixed)
// ---------------------------
function showAdOverlay(userRef, currentPrize) {
  const adOverlay = document.createElement("div");
  adOverlay.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.85);
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    z-index: 9999; color: #fff;
  `;

  adOverlay.innerHTML = `
    <div style="
      background: #fff; border-radius: 14px; padding: 25px;
      text-align: center; width: 85%; max-width: 420px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      color: #000; font-family: 'Poppins', sans-serif;">
      <h2 style="color: #0288d1; font-weight: 600; margin-bottom: 10px;">
        Ad is Playing...
      </h2>
      <p id='countdownText' style="font-size: 16px;">
        Please wait 30 seconds...
      </p>
      <div id="adContainer" style="margin: 12px 0; height: 250px;"></div>
      <button id='skipBtn' style="
        margin-top: 18px; background: #0288d1; color: #fff;
        border: none; border-radius: 8px; padding: 10px 22px;
        cursor: pointer; font-size: 15px; font-weight: 500;
        display: none; transition: all 0.3s ease;">
        Skip Ad
      </button>
    </div>
  `;

  document.body.appendChild(adOverlay);

  // --- Inject Adsterra script ---
  const s1 = document.createElement("script");
  s1.innerHTML = `
    atOptions = {
      'key': '881f54a3710d190b5f6727ff89c6cd51',
      'format': 'iframe',
      'height': 250,
      'width': 300,
      'params': {}
    };
  `;
  const s2 = document.createElement("script");
  s2.src = "//www.highperformanceformat.com/881f54a3710d190b5f6727ff89c6cd51/invoke.js";
  adOverlay.querySelector("#adContainer").appendChild(s1);
  adOverlay.querySelector("#adContainer").appendChild(s2);

  // --- Countdown + Skip logic ---
  let countdown = 30;
  const countdownText = adOverlay.querySelector("#countdownText");
  const skipBtn = adOverlay.querySelector("#skipBtn");

  // Show skip button after 25 seconds
  setTimeout(() => {
    skipBtn.style.display = "inline-block";
    skipBtn.style.opacity = "1";
  }, 25000);

  const timer = setInterval(() => {
    countdown--;
    countdownText.textContent = `Please wait ${countdown} seconds...`;

    if (countdown <= 0) {
      clearInterval(timer);
      countdownText.textContent = "Ad finished! Closing...";
      setTimeout(() => {
        adOverlay.remove();
        rewardUser(userRef, currentPrize);
      }, 1000);
    }
  }, 1000);

  // Skip button click handler
  skipBtn.addEventListener("click", () => {
    clearInterval(timer);
    countdownText.textContent = "Ad skipped. Reward added!";
    skipBtn.disabled = true;
    skipBtn.style.opacity = "0.6";
    setTimeout(() => {
      adOverlay.remove();
      rewardUser(userRef, currentPrize);
    }, 1000);
  });
}

// Reward function
function rewardUser(userRef, currentPrize) {
  userRef.get().then(snapshot => {
    const data = snapshot.val();
    const newCoins = (data.coins || 0) + currentPrize;
    const newTodays = (data.todaysEarnings || 0) + currentPrize;

    userRef.update({ coins: newCoins, todaysEarnings: newTodays }).then(() => {
      document.querySelector('.overlay').style.display = 'none';
      document.getElementById('winMessage').style.display = 'none';
      document.querySelector('.spinBtn-2').style.pointerEvents = 'auto';
    });
  });
}
</script>
</body>
</html>

