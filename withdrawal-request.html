<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Withdrawal Requests - Coin To Real Cash</title>

<link rel="stylesheet" href="assets/css/withdrawal-request.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>

<body>
<div class="container">
  <header>
    <button onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
    <h2>Withdrawal Requests</h2>
  </header>

  <ul id="withdrawal-list"></ul>
  <div id="empty" class="empty-message hidden">No withdrawal requests yet.</div>
</div>

<script>
// ðŸ”¥ Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyAkWyk3q-zaDHkjDs90Bm2ih_qw-O_ZJQU",
  authDomain: "coin-to-real-cash.firebaseapp.com",
  databaseURL: "https://coin-to-real-cash-default-rtdb.firebaseio.com",
  projectId: "coin-to-real-cash"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const realtimeDB = firebase.database();

const listEl = document.getElementById("withdrawal-list");
const emptyEl = document.getElementById("empty");

// âœ… Create a single withdrawal card (fixed status class)
function createWithdrawalCard(req) {
  const details =
    req.method === "upi"
      ? `UPI ID: ${req.details?.upiId || "N/A"}`
      : `Account: ${req.details?.accountNumber || "N/A"}, IFSC: ${req.details?.ifscCode || "N/A"}`;

  const time = req.timestamp ? new Date(req.timestamp).toLocaleString() : "N/A";

  // Change "Approved" â†’ "Withdrawal Successful" for display text
  let displayStatus = req.status || "Pending";
  if (displayStatus === "Approved") displayStatus = "Withdrawal Successful";

  // Create a class-safe status token (remove spaces)
  const statusClass = (displayStatus || "Pending").replace(/\s+/g, "");

  // Show remark or default message
  const noteMessage =
    req.remark && req.remark.trim() !== ""
      ? `<div class="note remark">Admin Remark: ${req.remark}</div>`
      : displayStatus === "Withdrawal Successful"
      ? `<div class="note">Your withdrawal has been successfully processed.</div>`
      : displayStatus === "Rejected"
      ? `<div class="note">Your withdrawal was rejected. Please check remark.</div>`
      : `<div class="note">Your request will be approved within 24 hrs</div>`;

  return `
    <li>
      <div class="withdraw-card">
        <strong>${req.method?.toUpperCase() || "Unknown"} - â‚¹${req.amount || 0}</strong>
        <div class="details">${details}</div>
        <div class="status ${statusClass}">${displayStatus}</div>
        ${noteMessage}
        <small>${time}</small>
      </div>
    </li>`;
}

// âœ… Render withdrawal requests
function renderRequests(data) {
  listEl.innerHTML = "";

  if (!data || Object.keys(data).length === 0) {
    emptyEl.classList.remove("hidden");
    return;
  } else {
    emptyEl.classList.add("hidden");
  }

  // ðŸ•’ Sort requests by latest timestamp on top
  const requests = Object.entries(data)
    .map(([id, req]) => ({ id, ...req }))
    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

  // Add each sorted request to the list
  requests.forEach((req) => {
    listEl.insertAdjacentHTML("beforeend", createWithdrawalCard(req));
  });
}

// âœ… Fetch Realtime Database data
auth.onAuthStateChanged((user) => {
  if (!user) return (window.location.href = "index.html");

  const uid = user.uid;
  const userWithdrawalsRef = realtimeDB.ref(`withdrawals/${uid}`);

  userWithdrawalsRef.on("value", (snapshot) => {
    const data = snapshot.val();
    renderRequests(data);
  });
});
</script>
</body>
</html>
