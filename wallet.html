<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wallet - Coin To Real Cash</title>
<link rel="stylesheet" href="assets/css/wallet.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
<div class="container">
  <header><h1>CoinToRealCash</h1></header>

  <div class="balance-box">
      <div class="balance-item">
          <h3>Coins</h3>
          <p id="wallet-balance">0</p>
      </div>
      <div class="divider"></div>
      <div class="balance-item">
          <h3>Rupees</h3>
          <p id="winning-balance">₹0</p>
      </div>
  </div>

  <div class="method-select">
      <div class="method active" id="upi">
          <img src="https://upload.wikimedia.org/wikipedia/commons/e/e1/UPI-Logo-vector.svg" alt="UPI" />
      </div>
      <div class="method" id="bank"><i class="fas fa-university"></i></div>
  </div>

  <!-- UPI FORM -->
  <form id="upi-form" class="withdraw-form">
      <input type="text" id="upiId" placeholder="Enter your UPI ID" required />
      <input type="number" id="upiAmount" placeholder="Enter amount" required />
      <p class="note">Minimum Withdraw ₹10</p>
      <button class="withdraw-btn" type="submit">Withdraw</button>
  </form>

  <!-- BANK FORM -->
  <form id="bank-form" class="withdraw-form hidden">
      <input type="text" id="holderName" placeholder="Account holder name" required />
      <input type="text" id="accountNumber" placeholder="Account number" required />
      <input type="text" id="bankName" placeholder="Bank name" required />
      <input type="text" id="ifscCode" placeholder="IFSC code" required />
      <input type="number" id="bankAmount" placeholder="Enter amount" required />
      <p class="note">Minimum Withdraw ₹10</p>
      <button class="withdraw-btn" type="submit">Withdraw</button>
  </form>

  <!-- Link to Withdrawal Requests Page -->
  <div style="margin-top: 20px; text-align: center;">
    <a href="withdrawal-request.html" style="text-decoration:none; color:#007bff;">View Withdrawal Requests</a>
  </div>
</div>

<!-- Bottom Navigation -->
<div class="bottom-nav">
    <a href="home.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a>
    <a href="invite.html" class="nav-item"><i class="fas fa-user-plus"></i><span>Invite</span></a>
    <a href="wallet.html" class="nav-item active"><i class="fas fa-wallet"></i><span>Wallet</span></a>
    <a href="profile.html" class="nav-item"><i class="fas fa-user-circle"></i><span>Profile</span></a>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAkWyk3q-zaDHkjDs90Bm2ih_qw-O_ZJQU",
  authDomain: "coin-to-real-cash.firebaseapp.com",
  databaseURL: "https://coin-to-real-cash-default-rtdb.firebaseio.com",
  projectId: "coin-to-real-cash",
  storageBucket: "coin-to-real-cash.firebasestorage.app",
  messagingSenderId: "265929655267",
  appId: "1:265929655267:web:7eb846fe7bd104761a56d6"
};
firebase.initializeApp(firebaseConfig);

const auth = firebase.auth();
const db = firebase.database();
const firestore = firebase.firestore();

document.addEventListener("DOMContentLoaded", () => {
  const walletEl = document.getElementById("wallet-balance");
  const rupeeEl = document.getElementById("winning-balance");
  const upiForm = document.getElementById("upi-form");
  const bankForm = document.getElementById("bank-form");
  const upiMethod = document.getElementById("upi");
  const bankMethod = document.getElementById("bank");

  // Toggle methods
  upiMethod.onclick = () => {
    upiForm.classList.remove("hidden");
    bankForm.classList.add("hidden");
    upiMethod.classList.add("active");
    bankMethod.classList.remove("active");
  };
  bankMethod.onclick = () => {
    bankForm.classList.remove("hidden");
    upiForm.classList.add("hidden");
    bankMethod.classList.add("active");
    upiMethod.classList.remove("active");
  };

  auth.onAuthStateChanged(async (user) => {
    if (!user) return (window.location.href = "index.html");

    const userRef = db.ref(`users/${user.uid}`);
    const withdrawalRef = db.ref(`withdrawals/${user.uid}`);

    const snap = await userRef.once("value");
    if (!snap.exists()) {
      await userRef.set({ coins: 0, todaysEarnings: 0, streak: 0, lastDailyBonus: "" });
    }

    userRef.on("value", (snapshot) => {
      const data = snapshot.val() || {};
      walletEl.textContent = data.coins || 0;
      rupeeEl.textContent = `₹${((data.coins || 0) * 0.01).toFixed(2)}`;
    });

    async function submitWithdrawal(request, amountInRupees) {
      const amountInCoins = amountInRupees * 100;
      try {
        const userSnapshot = await userRef.once("value");
        const currentCoins = userSnapshot.val().coins || 0;
        if (currentCoins < amountInCoins) return alert("Insufficient balance!");

        // Save to Realtime Database
        const newRef = withdrawalRef.push();
        await newRef.set(request);

        // Save to Firestore
        await firestore.collection("withdrawals")
          .doc(user.uid)
          .collection("requests")
          .add(request);

        // Update user coins
        await userRef.update({ coins: currentCoins - amountInCoins });
        alert("Withdrawal request submitted successfully!");
      } catch (err) {
        console.error("Withdrawal Error:", err);
        alert("Failed to submit request. Please try again.");
      }
    }

    upiForm.onsubmit = async (e) => {
      e.preventDefault();
      const upiId = document.getElementById("upiId").value.trim();
      const amount = parseFloat(document.getElementById("upiAmount").value);
      if (!upiId || amount < 10) return alert("Enter valid UPI ID and minimum ₹10.");
      const request = { method: "upi", details: { upiId }, amount, status: "Pending", timestamp: Date.now() };
      await submitWithdrawal(request, amount);
      upiForm.reset();
    };

    bankForm.onsubmit = async (e) => {
      e.preventDefault();
      const holderName = document.getElementById("holderName").value.trim();
      const accountNumber = document.getElementById("accountNumber").value.trim();
      const bankName = document.getElementById("bankName").value.trim();
      const ifscCode = document.getElementById("ifscCode").value.trim();
      const amount = parseFloat(document.getElementById("bankAmount").value);
      if (!holderName || !accountNumber || !bankName || !ifscCode || amount < 10)
        return alert("Please fill all details and enter minimum ₹10.");
      const request = { method: "bank", details: { holderName, accountNumber, bankName, ifscCode }, amount, status: "Pending", timestamp: Date.now() };
      await submitWithdrawal(request, amount);
      bankForm.reset();
    };
  });
});
</script>
</body>
</html>
