<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Forgot Password - Coin To Real Cash</title>
  <link rel="stylesheet" href="assets/css/forgot-password.css" />
  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-3213109580536726"
     crossorigin="anonymous"></script>
</head>
<body>
  <div class="container">
    <div class="card">
      <h2>Forgot Password</h2>
      <p class="label">Enter Email Address</p>
      <input type="email" id="email" placeholder="example@email.com" required />
      <button id="sendLinkBtn" class="btn">Send Reset Link</button>
      <p class="note"><a href="login.html">Back to Sign In</a></p>
      <p id="status" style="color:crimson; font-size:0.95rem; display:none;"></p>
    </div>
  </div>

  <script>
    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAkWyk3q-zaDHkjDs90Bm2ih_qw-O_ZJQU",
      authDomain: "coin-to-real-cash.firebaseapp.com",
      databaseURL: "https://coin-to-real-cash-default-rtdb.firebaseio.com",
      projectId: "coin-to-real-cash",
      storageBucket: "coin-to-real-cash.firebasestorage.app",
      messagingSenderId: "265929655267",
      appId: "1:265929655267:web:7eb846fe7bd104761a56d6"
    };

    // Initialize Firebase safely
    try {
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      } else {
        firebase.app();
      }
    } catch (e) {
      console.error("Firebase init error:", e);
      showStatus("Failed to initialize Firebase. Check console for details.", true);
    }

    const auth = firebase.auth();
    const db = firebase.database();

    const emailInput = document.getElementById("email");
    const sendBtn = document.getElementById("sendLinkBtn");
    const statusEl = document.getElementById("status");

    function showStatus(msg, isError = true) {
      statusEl.style.display = "block";
      statusEl.style.color = isError ? "crimson" : "green";
      statusEl.textContent = msg;
    }

    function clearStatus() {
      statusEl.style.display = "none";
      statusEl.textContent = "";
    }

    sendBtn.addEventListener("click", async () => {
      clearStatus();
      const emailRaw = emailInput.value || "";
      const email = emailRaw.trim().toLowerCase();

      if (!email) {
        showStatus("⚠️ Please enter your email address.");
        return;
      }

      // Basic email format validation
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showStatus("⚠️ Please enter a valid email format.");
        return;
      }

      sendBtn.disabled = true;
      sendBtn.textContent = "Checking...";

      try {
        // --- Step 1: Check if email exists in Realtime Database ---
        const usersRef = db.ref("users");
        const query = usersRef.orderByChild("email").equalTo(email);
        const snapshot = await query.once("value");

        console.log("Checking for:", email);
        console.log("Snapshot exists:", snapshot.exists());
        console.log("Snapshot value:", snapshot.val());

        if (!snapshot.exists()) {
          showStatus("❌ This email is not registered, please enter a valid email.");
          sendBtn.disabled = false;
          sendBtn.textContent = "Send Reset Link";
          return;
        }

        // --- Step 2: Send password reset link via Firebase Auth ---
        try {
          await auth.sendPasswordResetEmail(email);
          showStatus("✅ Password reset link sent! Check your email (and spam).", false);
          emailInput.value = "";
          console.info("Password reset email sent to:", email);
        } catch (authErr) {
          console.error("Auth sendPasswordResetEmail error:", authErr);

          if (authErr.code === "auth/user-not-found") {
            showStatus("❌ This email exists in the database but not in Firebase Authentication.");
          } else if (authErr.code === "auth/invalid-email") {
            showStatus("⚠️ Invalid email format for authentication.");
          } else if (authErr.code === "auth/network-request-failed") {
            showStatus("⚠️ Network error — please check your internet connection.");
          } else {
            showStatus("❌ Failed to send reset link. Please try again later.");
          }
        }
      } catch (dbErr) {
        console.error("Database query error:", dbErr);
        if (dbErr && dbErr.code === "PERMISSION_DENIED") {
          showStatus("❌ Database permission denied. Check Firebase Realtime Database rules.");
        } else {
          showStatus("❌ Something went wrong while checking your account. Try again later.");
        }
      } finally {
        sendBtn.disabled = false;
        sendBtn.textContent = "Send Reset Link";
      }
    });
  </script>
</body>
</html>
